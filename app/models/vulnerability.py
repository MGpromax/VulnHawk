"""
Vulnerability Model for VulnHawk

Represents discovered vulnerabilities with CVSS scoring and OWASP mapping.
"""

from datetime import datetime
from enum import Enum
from app import db
import json


class Severity(Enum):
    """Vulnerability severity levels based on CVSS v3.1."""
    CRITICAL = 'critical'  # 9.0 - 10.0
    HIGH = 'high'          # 7.0 - 8.9
    MEDIUM = 'medium'      # 4.0 - 6.9
    LOW = 'low'            # 0.1 - 3.9
    INFO = 'info'          # 0.0 (Informational)


class Confidence(Enum):
    """Detection confidence levels."""
    CONFIRMED = 'confirmed'  # Verified with proof of exploitation
    HIGH = 'high'            # Strong indicators
    MEDIUM = 'medium'        # Moderate indicators
    LOW = 'low'              # Weak indicators, possible false positive


class Vulnerability(db.Model):
    """
    Vulnerability model with comprehensive details.

    Features:
    - CVSS v3.1 scoring
    - OWASP Top 10 mapping
    - CWE references
    - Proof of concept data
    - Remediation guidance
    """

    __tablename__ = 'vulnerabilities'

    id = db.Column(db.Integer, primary_key=True)
    vuln_id = db.Column(db.String(36), unique=True, nullable=False, index=True)

    # Classification
    name = db.Column(db.String(255), nullable=False)
    vulnerability_type = db.Column(db.String(100), nullable=False, index=True)
    severity = db.Column(db.Enum(Severity), nullable=False, index=True)
    confidence = db.Column(db.Enum(Confidence), default=Confidence.MEDIUM)

    # Location
    url = db.Column(db.String(2048), nullable=False)
    parameter = db.Column(db.String(255), nullable=True)
    method = db.Column(db.String(10), default='GET')

    # Technical details
    description = db.Column(db.Text, nullable=False)
    evidence = db.Column(db.Text, nullable=True)  # Proof of vulnerability
    payload = db.Column(db.Text, nullable=True)   # Attack payload used
    response_snippet = db.Column(db.Text, nullable=True)  # Relevant response

    # CVSS v3.1 Scoring
    cvss_score = db.Column(db.Float, nullable=True)
    _cvss_vector = db.Column('cvss_vector', db.String(255), nullable=True)

    # References
    cwe_id = db.Column(db.String(20), nullable=True)  # e.g., "CWE-79"
    owasp_category = db.Column(db.String(50), nullable=True)  # e.g., "A03:2021"

    # Remediation
    remediation = db.Column(db.Text, nullable=True)
    references = db.Column(db.Text, nullable=True)  # JSON array of URLs

    # Metadata
    discovered_at = db.Column(db.DateTime, default=datetime.utcnow)
    is_false_positive = db.Column(db.Boolean, default=False)
    notes = db.Column(db.Text, nullable=True)

    # Relationship
    scan_id = db.Column(db.Integer, db.ForeignKey('scans.id'), nullable=False, index=True)

    # OWASP Top 10 2021 Mapping
    OWASP_MAPPING = {
        'xss': {'category': 'A03:2021', 'name': 'Injection'},
        'sqli': {'category': 'A03:2021', 'name': 'Injection'},
        'xxe': {'category': 'A03:2021', 'name': 'Injection'},
        'command_injection': {'category': 'A03:2021', 'name': 'Injection'},
        'csrf': {'category': 'A01:2021', 'name': 'Broken Access Control'},
        'idor': {'category': 'A01:2021', 'name': 'Broken Access Control'},
        'lfi': {'category': 'A01:2021', 'name': 'Broken Access Control'},
        'rfi': {'category': 'A01:2021', 'name': 'Broken Access Control'},
        'open_redirect': {'category': 'A01:2021', 'name': 'Broken Access Control'},
        'ssrf': {'category': 'A10:2021', 'name': 'Server-Side Request Forgery'},
        'ssl': {'category': 'A02:2021', 'name': 'Cryptographic Failures'},
        'weak_crypto': {'category': 'A02:2021', 'name': 'Cryptographic Failures'},
        'headers': {'category': 'A05:2021', 'name': 'Security Misconfiguration'},
        'info_disclosure': {'category': 'A05:2021', 'name': 'Security Misconfiguration'},
        'default_creds': {'category': 'A07:2021', 'name': 'Identification and Authentication Failures'},
        'weak_password': {'category': 'A07:2021', 'name': 'Identification and Authentication Failures'},
        'outdated_software': {'category': 'A06:2021', 'name': 'Vulnerable and Outdated Components'},
    }

    # CWE Mapping
    CWE_MAPPING = {
        'xss_reflected': 'CWE-79',
        'xss_stored': 'CWE-79',
        'xss_dom': 'CWE-79',
        'sqli': 'CWE-89',
        'sqli_blind': 'CWE-89',
        'csrf': 'CWE-352',
        'lfi': 'CWE-98',
        'rfi': 'CWE-98',
        'path_traversal': 'CWE-22',
        'open_redirect': 'CWE-601',
        'xxe': 'CWE-611',
        'ssrf': 'CWE-918',
        'command_injection': 'CWE-78',
        'info_disclosure': 'CWE-200',
        'weak_ssl': 'CWE-295',
        'missing_headers': 'CWE-693',
    }

    def __init__(self, scan_id, name, vulnerability_type, url, description,
                 severity=None, cvss_vector=None, **kwargs):
        """Initialize vulnerability with auto-classification."""
        import uuid

        self.vuln_id = str(uuid.uuid4())
        self.scan_id = scan_id
        self.name = name
        self.vulnerability_type = vulnerability_type
        self.url = url
        self.description = description

        # Auto-calculate severity from CVSS if provided
        if cvss_vector:
            self.cvss_vector = cvss_vector
            self.severity = self._severity_from_cvss(self.cvss_score)
        elif severity:
            # Convert string to Severity enum if needed
            self.severity = self._parse_severity(severity)
        else:
            self.severity = Severity.MEDIUM

        # Auto-map OWASP and CWE
        self._auto_classify()

        # Set additional fields
        for key, value in kwargs.items():
            if hasattr(self, key):
                setattr(self, key, value)

    @staticmethod
    def _parse_severity(severity):
        """Parse severity from string or Severity enum."""
        if isinstance(severity, Severity):
            return severity
        if isinstance(severity, str):
            # Try to match by value (lowercase)
            severity_lower = severity.lower()
            for s in Severity:
                if s.value == severity_lower:
                    return s
            # Try to match by name (uppercase)
            severity_upper = severity.upper()
            for s in Severity:
                if s.name == severity_upper:
                    return s
        return Severity.MEDIUM

    def _auto_classify(self):
        """Auto-classify vulnerability with OWASP and CWE mappings."""
        vuln_type = self.vulnerability_type.lower()

        # OWASP mapping
        if vuln_type in self.OWASP_MAPPING:
            self.owasp_category = self.OWASP_MAPPING[vuln_type]['category']

        # CWE mapping
        if vuln_type in self.CWE_MAPPING:
            self.cwe_id = self.CWE_MAPPING[vuln_type]

    @property
    def cvss_vector(self):
        """Get CVSS vector string."""
        return self._cvss_vector

    @cvss_vector.setter
    def cvss_vector(self, vector):
        """Set CVSS vector and calculate score."""
        self._cvss_vector = vector
        if vector:
            self.cvss_score = self._calculate_cvss_score(vector)

    @staticmethod
    def _calculate_cvss_score(vector):
        """
        Calculate CVSS v3.1 Base Score from vector string.

        Vector format: CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H
        """
        if not vector or not vector.startswith('CVSS:3.1/'):
            return None

        # CVSS v3.1 metric values
        metrics = {
            'AV': {'N': 0.85, 'A': 0.62, 'L': 0.55, 'P': 0.2},
            'AC': {'L': 0.77, 'H': 0.44},
            'PR': {
                'U': {'N': 0.85, 'L': 0.62, 'H': 0.27},
                'C': {'N': 0.85, 'L': 0.68, 'H': 0.5}
            },
            'UI': {'N': 0.85, 'R': 0.62},
            'S': {'U': 'Unchanged', 'C': 'Changed'},
            'C': {'H': 0.56, 'L': 0.22, 'N': 0},
            'I': {'H': 0.56, 'L': 0.22, 'N': 0},
            'A': {'H': 0.56, 'L': 0.22, 'N': 0}
        }

        try:
            # Parse vector
            parts = vector.replace('CVSS:3.1/', '').split('/')
            values = {}
            for part in parts:
                key, val = part.split(':')
                values[key] = val

            scope = values.get('S', 'U')

            # Get metric values
            av = metrics['AV'].get(values.get('AV', 'N'), 0.85)
            ac = metrics['AC'].get(values.get('AC', 'L'), 0.77)

            scope_key = 'C' if scope == 'C' else 'U'
            pr = metrics['PR'][scope_key].get(values.get('PR', 'N'), 0.85)

            ui = metrics['UI'].get(values.get('UI', 'N'), 0.85)
            c = metrics['C'].get(values.get('C', 'N'), 0)
            i = metrics['I'].get(values.get('I', 'N'), 0)
            a = metrics['A'].get(values.get('A', 'N'), 0)

            # Calculate Impact Sub Score (ISS)
            iss = 1 - ((1 - c) * (1 - i) * (1 - a))

            # Calculate Impact
            if scope == 'U':
                impact = 6.42 * iss
            else:
                impact = 7.52 * (iss - 0.029) - 3.25 * pow(iss - 0.02, 15)

            # Calculate Exploitability
            exploitability = 8.22 * av * ac * pr * ui

            # Calculate Base Score
            if impact <= 0:
                return 0.0

            if scope == 'U':
                base_score = min(impact + exploitability, 10)
            else:
                base_score = min(1.08 * (impact + exploitability), 10)

            # Round up to one decimal place
            return round(base_score * 10) / 10

        except (KeyError, ValueError, IndexError):
            return None

    @staticmethod
    def _severity_from_cvss(score):
        """Determine severity from CVSS score."""
        if score is None:
            return Severity.MEDIUM
        if score >= 9.0:
            return Severity.CRITICAL
        elif score >= 7.0:
            return Severity.HIGH
        elif score >= 4.0:
            return Severity.MEDIUM
        elif score > 0:
            return Severity.LOW
        return Severity.INFO

    @property
    def severity_color(self):
        """Get color for severity level (for UI)."""
        colors = {
            Severity.CRITICAL: '#dc3545',  # Red
            Severity.HIGH: '#fd7e14',      # Orange
            Severity.MEDIUM: '#ffc107',    # Yellow
            Severity.LOW: '#28a745',       # Green
            Severity.INFO: '#17a2b8'       # Blue
        }
        return colors.get(self.severity, '#6c757d')

    @property
    def owasp_info(self):
        """Get full OWASP category information."""
        vuln_type = self.vulnerability_type.lower()
        if vuln_type in self.OWASP_MAPPING:
            return self.OWASP_MAPPING[vuln_type]
        return None

    def get_references(self):
        """Get references as list."""
        if self.references:
            try:
                return json.loads(self.references)
            except json.JSONDecodeError:
                return []
        return []

    def set_references(self, refs):
        """Set references from list."""
        if isinstance(refs, list):
            self.references = json.dumps(refs)

    def mark_false_positive(self, notes=None):
        """Mark vulnerability as false positive."""
        self.is_false_positive = True
        if notes:
            self.notes = notes
        db.session.commit()

    def to_dict(self):
        """Convert vulnerability to dictionary for API responses."""
        return {
            'vuln_id': self.vuln_id,
            'name': self.name,
            'type': self.vulnerability_type,
            'severity': self.severity.value,
            'confidence': self.confidence.value,
            'url': self.url,
            'parameter': self.parameter,
            'method': self.method,
            'description': self.description,
            'evidence': self.evidence,
            'payload': self.payload,
            'cvss': {
                'score': self.cvss_score,
                'vector': self.cvss_vector
            },
            'cwe_id': self.cwe_id,
            'owasp_category': self.owasp_category,
            'owasp_info': self.owasp_info,
            'remediation': self.remediation,
            'references': self.get_references(),
            'discovered_at': self.discovered_at.isoformat() if self.discovered_at else None,
            'is_false_positive': self.is_false_positive
        }

    def __repr__(self):
        return f'<Vulnerability {self.name} - {self.severity.value}>'
